version: '3.8'

# üöÄ Claude Relay Service - Configuraci√≥n Autom√°tica para Coolify
# ‚úÖ No requiere configuraci√≥n manual de variables de entorno
# ‚úÖ Genera autom√°ticamente JWT_SECRET y ENCRYPTION_KEY
# ‚úÖ Incluye Redis configurado autom√°ticamente
# ‚úÖ Solo deploy y listo!

services:
  # üöÄ Claude Relay Service
  claude-relay:
    build: .
    container_name: ${COOLIFY_CONTAINER_NAME:-claude-relay-app}
    restart: unless-stopped
    ports:
      - '${PORT:-3011}:3011'
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
      - ./redis_data:/redis-data
    environment:
      # üåê Configuraci√≥n del servidor
      NODE_ENV: production
      PORT: 3011
      HOST: 0.0.0.0

      # üîê Configuraci√≥n de seguridad
      # Se generan autom√°ticamente en docker-entrypoint.sh si no existen
      JWT_SECRET: ${JWT_SECRET:-}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:-}
      ADMIN_SESSION_TIMEOUT: ${ADMIN_SESSION_TIMEOUT:-86400000}
      API_KEY_PREFIX: ${API_KEY_PREFIX:-cr_}

      # üìä Configuraci√≥n de Redis (autom√°tica)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}

      # üîó Configuraci√≥n de sesiones
      STICKY_SESSION_TTL_HOURS: ${STICKY_SESSION_TTL_HOURS:-1}
      STICKY_SESSION_RENEWAL_THRESHOLD_MINUTES: ${STICKY_SESSION_RENEWAL_THRESHOLD_MINUTES:-15}

      # üéØ Configuraci√≥n de Claude API
      CLAUDE_API_URL: ${CLAUDE_API_URL:-https://api.anthropic.com/v1/messages}
      CLAUDE_API_VERSION: ${CLAUDE_API_VERSION:-2023-06-01}
      CLAUDE_BETA_HEADER: ${CLAUDE_BETA_HEADER:-claude-code-20250219,oauth-2025-04-20,interleaved-thinking-2025-05-14,fine-grained-tool-streaming-2025-05-14,context-management-2025-06-27,context-1m-2025-08-07,web-search-2025-03-05}

      # üö´ Manejo de errores 529 y 400
      CLAUDE_OVERLOAD_HANDLING_MINUTES: ${CLAUDE_OVERLOAD_HANDLING_MINUTES:-0}
      CLAUDE_CONSOLE_BLOCKED_HANDLING_MINUTES: ${CLAUDE_CONSOLE_BLOCKED_HANDLING_MINUTES:-10}

      # üåê Configuraci√≥n de proxy
      DEFAULT_PROXY_TIMEOUT: ${DEFAULT_PROXY_TIMEOUT:-600000}
      MAX_PROXY_RETRIES: ${MAX_PROXY_RETRIES:-3}
      PROXY_USE_IPV4: ${PROXY_USE_IPV4:-true}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT:-600000}

      # üìà L√≠mites de uso
      DEFAULT_TOKEN_LIMIT: ${DEFAULT_TOKEN_LIMIT:-1000000}

      # üìù Configuraci√≥n de logs
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_MAX_SIZE: ${LOG_MAX_SIZE:-10m}
      LOG_MAX_FILES: ${LOG_MAX_FILES:-5}
      DEBUG: ${DEBUG:-false}
      DEBUG_HTTP_TRAFFIC: ${DEBUG_HTTP_TRAFFIC:-false}

      # üîß Configuraci√≥n del sistema
      CLEANUP_INTERVAL: ${CLEANUP_INTERVAL:-3600000}
      TOKEN_USAGE_RETENTION: ${TOKEN_USAGE_RETENTION:-2592000000}
      HEALTH_CHECK_INTERVAL: ${HEALTH_CHECK_INTERVAL:-60000}
      TIMEZONE_OFFSET: ${TIMEZONE_OFFSET:-8}
      METRICS_WINDOW: ${METRICS_WINDOW:-5}

      # üé® Configuraci√≥n de la interfaz web
      WEB_TITLE: ${WEB_TITLE:-Claude Relay Service}
      WEB_DESCRIPTION: ${WEB_DESCRIPTION:-Multi-account Claude API relay service}

      # üõ†Ô∏è Configuraci√≥n de desarrollo
      ENABLE_CORS: ${ENABLE_CORS:-true}
      TRUST_PROXY: ${TRUST_PROXY:-true}

      # üë• Gesti√≥n de usuarios (opcional)
      USER_MANAGEMENT_ENABLED: ${USER_MANAGEMENT_ENABLED:-false}
      DEFAULT_USER_ROLE: ${DEFAULT_USER_ROLE:-user}
      USER_SESSION_TIMEOUT: ${USER_SESSION_TIMEOUT:-86400000}
      MAX_API_KEYS_PER_USER: ${MAX_API_KEYS_PER_USER:-1}
      ALLOW_USER_DELETE_API_KEYS: ${ALLOW_USER_DELETE_API_KEYS:-false}

      # üîê LDAP (opcional)
      LDAP_ENABLED: ${LDAP_ENABLED:-false}

    depends_on:
      redis:
        condition: service_healthy
    networks:
      - claude-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3011/health']
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # üìä Redis Database
  redis:
    image: redis:7-alpine
    container_name: ${COOLIFY_CONTAINER_NAME:-claude-relay}-redis
    restart: unless-stopped
    command: redis-server --save 60 1 --appendonly yes --appendfsync everysec --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - ./redis_data:/data
    networks:
      - claude-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

networks:
  claude-network:
    driver: bridge

volumes:
  redis_data:
    driver: local
